---
- name: 🌟 Ensure ephemery directories exist

  ansible.builtin.file:
    path: '{{ item }}'
    state: directory
    mode: '0755'
    owner: '{{ ansible_user }}'
    group: '{{ ansible_user }}'
  loop:
    - '{{ ephemery_base_dir }}'
    - '{{ ephemery_base_dir }}/data/el'
    - '{{ ephemery_base_dir }}/data/cl'
    - '{{ ephemery_base_dir }}/scripts'
    - '{{ ephemery_base_dir }}/logs'

- name: 🔑 Include JWT secret management task
  ansible.builtin.import_tasks:
    file: jwt-secret.yaml
  tags: [jwt, security, always]

- name: 🔑 Add user to Docker group
  ansible.builtin.user:
    name: '{{ ansible_user }}'
    groups: docker
    append: true

- name: 📝 Create health check script
  ansible.builtin.template:
    src: templates/scripts/health_check.sh.j2
    dest: '{{ ephemery_scripts_dir }}/health_check.sh'
    force: true
    owner: '{{ ansible_user }}'
    group: '{{ ansible_user }}'
    mode: '0755'

- name: ⏱️ Setup cron job for health check
  ansible.builtin.cron:
    name: Ephemery health check
    minute: '*/5'
    job: '{{ ephemery_scripts_dir }}/health_check.sh'
    user: '{{ ansible_user }}'

  # Include client-specific configuration
- name: 🚀 Include client-specific configuration
  ansible.builtin.include_tasks:
    file: clients/{{ el }}-{{ cl }}/main.yaml
  when:
    - el in ['geth', 'besu', 'nethermind', 'reth', 'erigon']
    - cl in ['lighthouse', 'teku', 'prysm', 'lodestar']

  # Fallback to generic configuration if specific client combination is not available
- name: 🚀 Check if client-specific configuration exists
  ansible.builtin.stat:
    path: tasks/clients/{{ el }}-{{ cl }}/main.yaml
  register: client_config
  when:
    - el in ['geth', 'besu', 'nethermind', 'reth', 'erigon']
    - cl in ['lighthouse', 'teku', 'prysm', 'lodestar']

- name: 🚀 Check if Execution Client container exists
  community.docker.docker_container_info:
    name: '{{ network }}-{{ el }}'
  register: el_container_info
  ignore_errors: true

- name: 🚀 Remove existing Execution Client container if it exists
  community.docker.docker_container:
    name: '{{ network }}-{{ el }}'
    state: absent
    force_kill: true
  when: el_container_info.exists

- name: 🚀 Start Execution Client with generic configuration
  become: true
  community.docker.docker_container:
    name: '{{ network }}-{{ el }}'
    image: '{% if el == "geth" %}pk910/ephemery-geth{% else %}{{ client_images[el] }}{% endif %}'
    state: started
    restart_policy: unless-stopped
    network_mode: host
    memory: '{{ el_memory_limit }}'
    memory_swap: '{{ el_memory_limit }}'
    volumes:
      - '{{ ephemery_base_dir }}/data/{{ el }}:/data'
      - '{{ jwt_secret_path }}:/execution-auth.jwt:ro'
    command: >
      {% if el == "geth" %}
      --networkid=39438143
      --bootnodes=enode://50a54ecbd2175497640bcf46a25bbe9bb4fae51d7cc2a29ef4947a7ee17496cf39a699b7fe6b703ed0feb9dbaae7e44fc3827fcb7435ca9ac6de4daa4d983b3d@137.74.203.240:30303,enode://7367578e9d211512a59e2cdd2c600b8bb71199421aac9d4b0b26050098d551575684314ca8bf226930568e29507c45de1ee00ae1ca70c544b9ba8250ce1d66e1@167.235.1.185:30343
      --datadir=/data
      --authrpc.addr=0.0.0.0
      --authrpc.port=8551
      --authrpc.vhosts=*
      --authrpc.jwtsecret=/execution-auth.jwt
      --http
      --http.addr=0.0.0.0
      --http.port=8545
      --http.vhosts=*
      --http.api=eth,net,web3,engine
      --ws
      --ws.addr=0.0.0.0
      --ws.port=8546
      --ws.api=eth,net,web3
      --ws.origins=*
      --syncmode=snap
      --metrics
      --metrics.addr=0.0.0.0
      --metrics.port=6060
      {% else %}
      --datadir=/data
      --authrpc.addr=0.0.0.0
      --authrpc.port=8551
      --authrpc.vhosts=*
      --authrpc.jwtsecret=/execution-auth.jwt
      --http
      --http.addr=0.0.0.0
      --http.port=8545
      --http.vhosts=*
      --http.api=eth,net,web3,engine
      --ws
      --ws.addr=0.0.0.0
      --ws.port=8546
      --ws.api=eth,net,web3
      --ws.origins=*
      --syncmode=snap
      --metrics
      --metrics.addr=0.0.0.0
      --metrics.port=6060
      {{ el_extra_opts }}
      {% endif %}
  when: el == "geth" or el == "besu" or el == "nethermind" or el == "reth" or el == "erigon"

- name: 🚀 Check if Consensus Client container exists
  community.docker.docker_container_info:
    name: '{{ network }}-{{ cl }}'
  register: cl_container_info
  ignore_errors: true

- name: 🚀 Remove existing Consensus Client container if it exists
  community.docker.docker_container:
    name: '{{ network }}-{{ cl }}'
    state: absent
    force_kill: true
  when: cl_container_info.exists

- name: 🚀 Start Consensus Client with generic configuration
  become: true
  community.docker.docker_container:
    name: '{{ network }}-{{ cl }}'
    image: '{% if cl == "lighthouse" %}pk910/ephemery-lighthouse{% else %}{{ client_images[cl] }}{% endif %}'
    state: started
    restart_policy: unless-stopped
    network_mode: host
    memory: '{{ cl_memory_limit }}'
    memory_swap: '{{ cl_memory_limit }}'
    volumes:
      - '{{ ephemery_base_dir }}/data/beacon:/data'
      - '{{ jwt_secret_path }}:/execution-auth.jwt:ro'
    command: >
      {% if cl == "lighthouse" %}
      lighthouse beacon_node
      --datadir=/data
      --http
      --http-address=0.0.0.0
      --http-port=5052
      --execution-endpoint=http://localhost:8551
      --execution-jwt=/execution-auth.jwt
      --testnet-dir=/ephemery_config
      --allow-insecure-genesis-sync
      {{ cl_extra_opts }}
      {% elif cl == "teku" %}
      --data-path=/data
      --rest-api-enabled=true
      --rest-api-interface=0.0.0.0
      --rest-api-port=5052
      --metrics-enabled=true
      --metrics-interface=0.0.0.0
      --metrics-port=5054
      --ee-endpoint=http://127.0.0.1:8551
      --ee-jwt-secret-file=/execution-auth.jwt
      {{ cl_extra_opts }}
      {% elif cl == "prysm" %}
      --datadir=/data
      --rpc-host=0.0.0.0
      --rpc-port=5052
      --monitoring-host=0.0.0.0
      --monitoring-port=5054
      --execution-endpoint=http://127.0.0.1:8551
      --jwt-secret=/execution-auth.jwt
      {{ cl_extra_opts }}
      {% elif cl == "lodestar" %}
      --dataDir=/data
      --rest
      --rest.address=0.0.0.0
      --rest.port=5052
      --metrics
      --metrics.address=0.0.0.0
      --metrics.port=5054
      --execution.urls=http://127.0.0.1:8551
      --jwt-secret=/execution-auth.jwt
      {{ cl_extra_opts }}
      {% endif %}
  when: cl in ["lighthouse", "teku", "prysm", "lodestar"]

- name: 📊 Start Grafana agent
  community.docker.docker_container:
    name: grafana-agent
    image: grafana/agent:v0.37.3
    state: started
    pull: true
    restart_policy: unless-stopped
    network_mode: host
    privileged: true
    volumes:
      - '{{ ephemery_base_dir }}/ephemery/config/grafana/agent/grafana-agent.yaml:/etc/agent/grafana-agent.yaml:ro'
    command:
      - '--config.file=/etc/agent/grafana-agent.yaml'
      - '--server.http.address=0.0.0.0:{{ grafana_agent_http_port }}'
