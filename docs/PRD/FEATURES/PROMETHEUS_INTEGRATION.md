# Prometheus Integration

This document explains how Prometheus is integrated and configured in the Ephemery system for metrics collection and monitoring.

## Overview

Prometheus is a powerful monitoring and alerting toolkit that collects and stores time-series data from various sources. In the Ephemery system, Prometheus is used to collect metrics from:

- Execution client (Geth)
- Consensus client (Lighthouse)
- Validator client
- Node exporter (system metrics)
- Custom Ephemery metrics

These metrics are then used by Grafana dashboards and alerting systems to provide insights into the health and performance of your Ephemery nodes.

## Prometheus Architecture

The Prometheus integration in Ephemery follows this architecture:

1. **Metrics Exporters**: Components that expose metrics in a format Prometheus can scrape
2. **Prometheus Server**: Collects and stores metrics from exporters
3. **Grafana**: Visualizes metrics collected by Prometheus
4. **Alertmanager** (optional): Handles alerts generated by Prometheus

## Prometheus Configuration

### Default Configuration

The default Prometheus configuration is located at:

```
/opt/ephemery/config/prometheus.yaml
```

This configuration file defines:
- Global settings (scrape interval, evaluation interval)
- Scrape configurations for each metrics source
- Relabeling rules for better metric organization

### Example Configuration

```yaml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: "prometheus"
    static_configs:
      - targets: ["localhost:9090"]

  - job_name: "lighthouse"
    metrics_path: /metrics
    static_configs:
      - targets: ["ephemery-lighthouse:5054"]
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: "lighthouse"

  - job_name: "geth"
    metrics_path: /debug/metrics/prometheus
    static_configs:
      - targets: ["ephemery-geth:6060"]
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: "geth"

  - job_name: "node_exporter"
    static_configs:
      - targets: ['node-exporter:9100']

  - job_name: "validator-metrics"
    metrics_path: /metrics
    static_configs:
      - targets: ["localhost:8009"]
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: "validator"
```

## Metrics Sources

### Execution Client (Geth)

Geth exposes Prometheus metrics at:

```
http://ephemery-geth:6060/debug/metrics/prometheus
```

Key metrics include:
- Block processing time
- Transaction pool statistics
- Peer count and network status
- Sync status and progress

### Consensus Client (Lighthouse)

Lighthouse exposes Prometheus metrics at:

```
http://ephemery-lighthouse:5054/metrics
```

Key metrics include:
- Attestation processing
- Block processing
- Peer count and network status
- Sync status and progress

### Validator Client

The validator client exposes Prometheus metrics at:

```
http://localhost:8009/metrics
```

Key metrics include:
- Validator balance
- Attestation effectiveness
- Proposal count
- Validator status

### Node Exporter

Node exporter provides system-level metrics at:

```
http://node-exporter:9100/metrics
```

Key metrics include:
- CPU usage
- Memory usage
- Disk usage and I/O
- Network traffic

## Deployment

### Automatic Deployment

Prometheus is automatically deployed when you deploy an Ephemery node with monitoring enabled:

```bash
# Deploy with monitoring enabled
./scripts/deploy-ephemery.sh --monitoring

# Or enable monitoring in your inventory file
# monitoring_enabled: true
```

### Manual Deployment

You can also deploy Prometheus manually:

```bash
ansible-playbook -i inventory.yaml playbooks/deploy_monitoring.yaml
```

### Docker Deployment

If you're using Docker, Prometheus is deployed as a container:

```yaml
# From docker-compose.yaml
prometheus:
  image: prom/prometheus:v2.37.0
  volumes:
    - ./prometheus.yaml:/etc/prometheus/prometheus.yml
    - prometheus_data:/prometheus
  command:
    - '--config.file=/etc/prometheus/prometheus.yml'
    - '--storage.tsdb.path=/prometheus'
    - '--web.console.libraries=/usr/share/prometheus/console_libraries'
    - '--web.console.templates=/usr/share/prometheus/consoles'
  ports:
    - "9090:9090"
  restart: unless-stopped
```

## Accessing Prometheus

Once deployed, you can access the Prometheus web interface at:

```
http://YOUR_SERVER_IP:9090
```

This interface allows you to:
- Query metrics using PromQL
- View targets and their status
- Explore the metrics being collected
- View and manage alerts

## Custom Metrics

Ephemery provides custom metrics for monitoring specific aspects of the system:

### Validator Performance Metrics

Custom metrics for validator performance:

- `ephemery_validator_balance`: Current validator balance
- `ephemery_validator_effectiveness`: Attestation effectiveness percentage
- `ephemery_validator_proposals`: Number of block proposals
- `ephemery_validator_status`: Validator status (active, pending, exited)

### Sync Status Metrics

Custom metrics for sync status:

- `ephemery_sync_progress`: Sync progress percentage
- `ephemery_sync_eta`: Estimated time to completion
- `ephemery_sync_speed`: Sync speed (blocks per second)

## Alerting

Prometheus can be configured to generate alerts based on metric values. Ephemery provides default alerting rules for common issues:

```yaml
# Example alerting rules
groups:
  - name: ephemery
    rules:
      - alert: NodeDown
        expr: up == 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Node {{ $labels.instance }} is down"
          description: "{{ $labels.instance }} has been down for more than 5 minutes."

      - alert: ValidatorMissedAttestations
        expr: ephemery_validator_effectiveness < 90
        for: 1h
        labels:
          severity: warning
        annotations:
          summary: "Validator effectiveness below threshold"
          description: "Validator effectiveness is {{ $value }}%, which is below the 90% threshold."
```

## Troubleshooting

### Common Issues

1. **Prometheus not starting**:
   - Check if the configuration file is valid
   - Verify that the data directory is writable
   - Check system resources (memory, disk space)

2. **Targets showing as down**:
   - Verify that the target services are running
   - Check network connectivity between Prometheus and targets
   - Verify that the target endpoints are correct

3. **Missing metrics**:
   - Check if the metrics are being exposed by the targets
   - Verify that Prometheus is scraping the correct endpoints
   - Check for errors in the Prometheus logs

### Debugging Commands

```bash
# Check Prometheus status
systemctl status prometheus

# Validate Prometheus configuration
promtool check config /opt/ephemery/config/prometheus.yaml

# Check Prometheus logs
journalctl -u prometheus

# Check if targets are accessible
curl -s http://ephemery-lighthouse:5054/metrics | head
curl -s http://ephemery-geth:6060/debug/metrics/prometheus | head
```

## Related Documentation

- [Dashboard Integration](DASHBOARD_INTEGRATION.md)
- [Validator Monitoring](VALIDATOR_MONITORING.md)
- [Sync Monitoring](SYNC_MONITORING.md)
